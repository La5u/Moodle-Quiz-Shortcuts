// ==UserScript==
// @name         Moodle Quiz Shorcuts
// @namespace    http://tampermonkey.net/
// @version      2025-02-11
// @description  Enter/Backspace for Next/Previous question, Up/Down for selecting multiple choice question
// @author       Lasu Shin
// @match        https://moodle.yerlan.top/mod/quiz/*
// @icon         https://moodle.yerlan.top/theme/image.php/boost/theme/1730285596/favicon
// @grant        none
// @downloadURL https://update.greasyfork.org/scripts/524310/Moodle%20Quiz%20Shorcuts.user.js
// @updateURL https://update.greasyfork.org/scripts/524310/Moodle%20Quiz%20Shorcuts.meta.js
// ==/UserScript==

// ENABLE DEV MODE IN CHROME/EDGE

//TODO
//return prev btn without taking away enter functionality

const prev_btn = document.getElementById('mod_quiz-prev-nav')
const text_field = document.getElementsByClassName('form-control d-inline')[0]
const answers = document.getElementsByClassName('answer')[0]
let radios = []
let multiple_choice = false
let selected = 0
if (prev_btn) {
    //remove button bec sometimes it goes back
    prev_btn.remove()
}

// if the question is a text field answer, select it
if (text_field) {
    text_field.select()
}
// if the question has multiple choices, add them to the list radios

else if (answers) {
    const isRadio = answers.children[0]?.children[0]?.type === "radio";
    multiple_choice = !isRadio; // Set multiple_choice to true if not radio

    for (let child of answers.children) {
        radios.push(isRadio ? child.children[0] : child.children[1]);
    }


    for (let i = 0; i < answers.children.length; i++) {
        if (radios[i].checked) {
            selected = i
            break
        }
    }
}



function check(radio) {
    if (multiple_choice) {
        radio.click()
    } else {
        radio.checked = true
    }
}

function normalize(text) {
    const words = text.split(' ');
    const startIndex = words.indexOf('Answer');

    // If "Answer" is found, remove 3 words starting from it
    if (startIndex !== -1) {
        return words
            .slice(0, startIndex) // Keep everything before "Answer"
            .concat(words.slice(startIndex + 3)) // Skip 3 words after "Answer"
            .join(' '); // Join back into a string
    }

    // If "Answer" isn't found, return the original text
    return text;
}


function saveQuizAnswers() {
    // Only run if we're on the correct page
    if (!window.location.href.startsWith('https://moodle.yerlan.top/mod/quiz/review.php')) {
        return;
    }

    const answers = {};

    const form = document.getElementById('region-main')
        .children[3]
        .children[1]
        .children[0]
        .children;

    if (form.length <=3) {
        return
    }

    for (let question of form) {
        if (!question || !question.children[1]) {
            continue
        }
        const questionElements = question.children[1].children;

        const questionText = normalize(questionElements[0].children[2].textContent)
        const questionAnswer = questionElements[1].innerText.split(': ')[1];
        answers[questionText] = questionAnswer;
    }

    localStorage.setItem('lastReviewAnswers', JSON.stringify(answers));
    alert('SAVED ANSWERS');
    console.log(answers)
}

function handleNextButton() {
    const next_btn = document.getElementById('mod_quiz-next-nav')
    if (!next_btn) {
        console.log('Next button not found!')
        let submit_btn = document.getElementsByClassName('btn btn-primary')[0]
        let save_btn = document.querySelector('.btn.btn-primary[data-action=save]')
        if (!save_btn) {
            submit_btn.click()
        } else {
            save_btn.click()
        }
    } else {
        next_btn.click()
    }
}

function answer(savedAnswer) {
    if (text_field) {
        text_field.value = savedAnswer;
    } else if (radios.length > 0) {
        for (let radio of radios) {
            const answerText = radio.parentElement.children[multiple_choice ? 2 : 1].textContent.substr(3)
            if (answerText == savedAnswer) {
                console.log(answerText, savedAnswer)
                check(radio)
                break;
            }
        }
    }
    handleNextButton()
}

function autoAnswer() {
    // Check if there are saved answers in localStorage
    const savedAnswers = localStorage.getItem('lastReviewAnswers');
    if (savedAnswers) {
        const answers = JSON.parse(savedAnswers);
        const questionElement = document.querySelector('.qtext');
        if (questionElement) {

            let questionText = normalize(questionElement.textContent)
            console.log(questionText)
            const savedAnswer = answers[questionText];

            // If we have a saved answer for this question
            if (savedAnswer) {
                answer(savedAnswer)
            }
        }
    }
}

autoAnswer()
saveQuizAnswers()

// listen for keydown events (up, down, enter, backspace)
document.addEventListener( "keydown", function( e ) {
    var keyCode = e.keyCode || e.which;
    // check whether its a multiple choice question before checking for up and down arrows for movement
    if (answers) {
        let found_radio = false
        // DOWN ARROW - SELLECT PREVIOUS OPTION
        if (keyCode === 40) {
            selected = (selected + 1) % radios.length
            check(radios[selected])


        // UP ARROW - SELECT NEXT OPTION
        } else if (keyCode === 38) {
            selected = (selected + 3) % radios.length
            check(radios[selected])
        }
    }

    // SHIFT + ENTER - GO BACK
    if (e.shiftKey && keyCode === 13) {
        window.history.back();
    }
    // ENTER - NEXT QUESTION BUTTON
    else if (keyCode === 13) {
        handleNextButton();
    }

}, false);



